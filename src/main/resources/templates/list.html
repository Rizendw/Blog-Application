<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <title>My Blog Application</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            color: #000;
            background-color: #fff;
            margin: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 14px;
        }

        form {
            margin-bottom: 15px;
            font-size: 14px;
        }

        input, select, button {
            border: 1px solid #000;
            padding: 3px 5px;
            font-size: 13px;
        }

        a {
            color: black;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        /* === Two-column layout with equal boxes === */
        .post-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: space-between;
        }

        .post {
            flex: 1 1 calc(50% - 10px);
            border: 1px solid #000;
            padding: 8px;
            box-sizing: border-box;
            height: 150px; /* fixed height for equal box size */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 14px;
        }

        .post-title {
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .post-meta {
            font-size: 12px;
            color: #333;
            margin-bottom: 5px;
        }

        .post-excerpt {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3; /* limit to 3 lines */
            -webkit-box-orient: vertical;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>

<h1>My Blog Application</h1>

<div class="top-bar" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
    <div><a href="/create">+ Create New Post</a></div>

    <!-- If user is not logged in -->
    <div sec:authorize="isAnonymous()">
        <a href="/login" style="margin-right:10px;">Login</a>
        <a href="/signup">Sign Up</a>
    </div>

    <!-- If user is logged in -->
    <div sec:authorize="isAuthenticated()">
        <form th:action="@{/logout}" method="post" style="display:inline;">
            <span sec:authentication="name" style="margin-right:10px;"></span>
            <button type="submit" style="border:none; background:none; color:blue; cursor:pointer;">
                Logout
            </button>
        </form>
    </div>
</div>


<form method="get" th:action="@{/}">

    <!-- Search text -->
    <input type="text" name="search" placeholder="Search..." th:value="${search}" />

    <!-- Author filter -->
    <input type="text" name="author" placeholder="Author" th:value="${authorFilter}" />

    <!-- Tag filter (multi-select) -->
    <label for="tagSelect">Filter by Tags:</label>
    <select id="tagSelect" name="tagId" multiple size="5">
        <option th:each="tag : ${allTags}"
                th:value="${tag.id}"
                th:text="${tag.name}"
                th:selected="${#lists.contains(selectedTagIds, tag.id)}">
        </option>
    </select>

    <!-- Published filter -->
    <select name="published">
        <option value="" th:selected="${isPublished == null}">All</option>
        <option value="true" th:selected="${isPublished == true}">Published</option>
        <option value="false" th:selected="${isPublished == false}">Draft</option>
    </select>

    <!-- Date range filters -->
    <input type="date" name="dateFrom" th:value="${dateFrom}" />
    <input type="date" name="dateTo" th:value="${dateTo}" />

    <!-- Sorting -->
    <select name="sortField">
        <option value="updatedAt" th:selected="${sortField == 'updatedAt'}">Updated</option>
        <option value="createdAt" th:selected="${sortField == 'createdAt'}">Created</option>
        <option value="title" th:selected="${sortField == 'title'}">Title</option>
    </select>

    <select name="sortDir">
        <option value="desc" th:selected="${sortDir == 'desc'}">DESC</option>
        <option value="asc" th:selected="${sortDir == 'asc'}">ASC</option>
    </select>

    <button type="submit">Apply</button>
    <a href="/" style="margin-left:10px;">Clear</a>
</form>


<!-- Post List -->
<div class="post-list">
    <div class="post" th:each="post : ${posts}">
        <div class="post-title">
            <a th:href="@{'/' + ${post.id}}" th:text="${post.title}">Post title</a>
        </div>
        <div class="post-meta">
            <span th:text="${post.authorName()}">Author</span>,
            <span th:text="${#temporals.format(post.createdAt, 'dd/MM/yyyy')}">Date</span>
        </div>
        <div class="post-excerpt" th:text="${post.excerpt}">Excerpt text...</div>
    </div>
</div>

<div class="pagination">
    <a th:if="${hasPrev}"
       th:href="@{/(page=${currentPage - 1},q=${search},tagId=${selectedTagIds},author=${authorFilter},isPublished=${isPublished},sortField=${sortField},sortDir=${sortDir})}">
        &lt; Previous
    </a>
    <a th:if="${hasNext}"
       th:href="@{/(page=${currentPage + 1},q=${search},tagId=${selectedTagIds},author=${authorFilter},isPublished=${isPublished},sortField=${sortField},sortDir=${sortDir})}">
        Next &gt;
    </a>
</div>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const tagSelect = document.getElementById("tagSelect");
        try {
            const res = await fetch("/tags");
            const tags = await res.json();
            tags.sort((a, b) => a.name.localeCompare(b.name));
            tags.forEach(tag => {
                const opt = document.createElement("option");
                opt.value = tag.id;
                opt.textContent = tag.name;
                if (new URLSearchParams(window.location.search).getAll("tagId").includes(String(tag.id))) {
                    opt.selected = true;
                }
                tagSelect.appendChild(opt);
            });
        } catch (e) {
            console.error("Failed to load tags", e);
        }
    });
</script>

</body>
</html>
